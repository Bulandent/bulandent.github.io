<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="baidu-site-verification" content="1EB8XoOl0C"><meta name="google-site-verification" content="K7thEgdLm0UfRWJ5MGdF7sCcjClSzAlxFLPv2Oz5CGM"><title> Vue-Test-Utils + Jest 单元测试入门与实践 · 步步走</title><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="Vue-Test-Utils + Jest 单元测试入门与实践、"><meta name="keywords" content="Vue Test Utils、Jest、单元测试、vue"><meta name="author" content="typeR"><link rel="short icon" href="https://bubuzou.oss-cn-shenzhen.aliyuncs.com/blog/202010/favicon.ico"><link rel="stylesheet" href="https://bubuzou.oss-cn-shenzhen.aliyuncs.com/blog/202010/bubuzou.css"><link rel="search" type="application/opensearchdescription+xml" href="https://bubuzou.com/atom.xml" title="步步走"><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src='//unpkg.com/valine/dist/Valine.min.js'></script><meta name="generator" content="Hexo 5.0.0"><link rel="alternate" href="/atom.xml" title="步步走" type="application/atom+xml">
</head><body><header><div class="header row"> <a href="/" class="logo-link"><img src="https://bubuzou.oss-cn-shenzhen.aliyuncs.com/blog/202010/logo.png"></a><ul id="nav_list" class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" data-hover="博文" class="nav-list-link">博文</a></li><li class="nav-list-item"><a href="/archives/" target="_self" data-hover="归档" class="nav-list-link">归档</a></li><li class="nav-list-item"><a href="/categories/live/" target="_self" data-hover="生活" class="nav-list-link">生活</a></li><li class="nav-list-item"><a href="/categories/read/" target="_self" data-hover="读书" class="nav-list-link">读书</a></li><li class="nav-list-item"><a href="/about/" target="_self" data-hover="关于" class="nav-list-link">关于</a></li></ul><div class="search"><a id="search_btn" href="#search"></a></div><div id="nav_btn" class="nav-btn"><span></span><span></span><span></span></div></div></header><div class="row scroll-con"><section class="container"><!-- for archive page--><div id="postAr" class="post"><article class="post-block"><h1 class="post-title">Vue-Test-Utils + Jest 单元测试入门与实践</h1><div class="post-info">2019-10-24<p class="visit"><i data-identity="2019/10/24/Vue-Test-Utils+Jest/" class="article-timer"></i><span>次访问</span></p></div><div class="post-content"><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p><a target="_blank" rel="noopener" href="https://vue-test-utils.vuejs.org/zh/"><code>Vue-Test-Utils</code></a> 是 <code>Vue.js</code> 官方的单元测试实用工具库，它提供了一系列的 <code>API</code> 来使得我们可以很便捷的去写 <code>Vue</code> 应用中的单元测试。</p>
<p>主流的单元测试运行器有很多，比如 <a target="_blank" rel="noopener" href="https://jestjs.io/docs/zh-Hans/getting-started"><code>Jest</code></a>、<a target="_blank" rel="noopener" href="https://mochajs.org/"><code>Mocha</code></a> 和 <code>Karma</code> 等，这几个在 <code>Vue-Test-Utils</code> 文档里都有对应的教程，这里我们只介绍 <code>Vue-Test-Utils + Jest</code> 结合的示例。</p>
<blockquote>
<p>Jest 是一个由 Facebook 开发的测试框架。Vue 对其进行描述：是功能最全的测试运行器。它所需的配置是最少的，默认安装了 JSDOM，内置断言且命令行的用户体验非常好。不过你需要一个能够将单文件组件导入到测试中的预处理器。我们已经创建了 vue-jest 预处理器来处理最常见的单文件组件特性，但仍不是 vue-loader 100% 的功能。</p>
</blockquote>
<a id="more"></a>

<h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><p>通过脚手架 <code>vue-cli</code> 来新建项目的时候，如果选择了 <code>Unit Testing</code> 单元测试且选择的是 <code>Jest</code> 作为测试运行器，那么在项目创建好后，就会自动配置好单元测试需要的环境，直接能用 <code>Vue-Test-Utils</code> 和 <code>Jest</code> 的 <code>API</code> 来写测试用例了。</p>
<p>但是新建项目之初没有选择单元测试功能，需要后面去添加的话，有两种方案：</p>
<p>第一种配置：</p>
<p>直接在项目中添加一个 <a target="_blank" rel="noopener" href="https://github.com/vuejs/vue-docs-zh-cn/tree/master/vue-cli-plugin-unit-jest"><code>unit-jest</code></a> 插件，会自动将需要的依赖安装配置好。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vue add @vue&#x2F;unit-jest</span><br></pre></td></tr></table></figure>

<p>第二种配置：</p>
<p>这种配置会麻烦一点，下面是具体的操作步骤。</p>
<h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><ul>
<li><p>安装 <code>Jest</code> 和 <code>Vue Test Utils</code></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev jest @vue&#x2F;test-utils</span><br></pre></td></tr></table></figure></li>
<li><p>安装 <code>babel-jest</code> 、 <code>vue-jest</code> 和 <code>7.0.0-bridge.0</code> 版本的 <code>babel-core</code></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev babel-jest vue-jest babel-core@7.0.0-bridge.0</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装 <code>jest-serializer-vue</code></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev jest-serializer-vue</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="配置-Jest"><a href="#配置-Jest" class="headerlink" title="配置 Jest"></a>配置 <code>Jest</code></h3><p><code>Jest</code> 的配置可以在 <code>package.json</code> 里配置；也可以新建一个文件 <code>jest.config.js</code>， 放在项目根目录即可。这里我选择的是配置在 <code>jest.config.js</code> 中：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    moduleFileExtensions: [</span><br><span class="line">        <span class="string">&#x27;js&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;vue&#x27;</span></span><br><span class="line">    ],</span><br><span class="line">    transform: &#123;</span><br><span class="line">        <span class="string">&#x27;^.+\\.vue$&#x27;</span>: <span class="string">&#x27;&lt;rootDir&gt;/node_modules/vue-jest&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;^.+\\.js$&#x27;</span>: <span class="string">&#x27;&lt;rootDir&gt;/node_modules/babel-jest&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    moduleNameMapper: &#123;</span><br><span class="line">        <span class="string">&#x27;^@/(.*)$&#x27;</span>: <span class="string">&#x27;&lt;rootDir&gt;/src/$1&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    snapshotSerializers: [</span><br><span class="line">        <span class="string">&#x27;jest-serializer-vue&#x27;</span></span><br><span class="line">    ],</span><br><span class="line">    testMatch: [<span class="string">&#x27;**/__tests__/**/*.spec.js&#x27;</span>],</span><br><span class="line">    transformIgnorePatterns: [<span class="string">&#x27;&lt;rootDir&gt;/node_modules/&#x27;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>各配置项说明：</p>
<ul>
<li><code>moduleFileExtensions</code> 告诉 <code>Jest</code> 需要匹配的文件后缀</li>
<li><code>transform</code> 匹配到 <code>.vue</code> 文件的时候用 <code>vue-jest</code> 处理， 匹配到 <code>.js</code> 文件的时候用 <code>babel-jest</code> 处理</li>
<li><code>moduleNameMapper</code> 处理 <code>webpack</code> 的别名，比如：将 <code>@</code> 表示 <code>/src</code> 目录</li>
<li><code>snapshotSerializers</code> 将保存的快照测试结果进行序列化，使得其更美观 </li>
<li><code>testMatch</code> 匹配哪些文件进行测试</li>
<li><code>transformIgnorePatterns</code> 不进行匹配的目录</li>
</ul>
<h3 id="配置-package-json"><a href="#配置-package-json" class="headerlink" title="配置 package.json"></a>配置 <code>package.json</code></h3><p>写一个执行测试的命令脚本：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;script&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;test&quot;</span>: <span class="string">&quot;jest&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="第一个测试用例"><a href="#第一个测试用例" class="headerlink" title="第一个测试用例"></a>第一个测试用例</h2><p>为了保证环境的一致性，我们从创建项目开始一步一步演示操作步骤。</p>
<h3 id="用-vue-cli-创建一个项目"><a href="#用-vue-cli-创建一个项目" class="headerlink" title="用 vue-cli 创建一个项目"></a>用 <code>vue-cli</code> 创建一个项目</h3><p>当前我用到的是 <code>3.10.0</code> 版本的 <code>vue-cli</code>。开始创建项目：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vue create first-vue-jest</span><br></pre></td></tr></table></figure>

<p>选择 <code>Manually select features</code> 进行手动选择功能配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Vue CLI v3.10.0</span><br><span class="line">┌───────────────────────────┐</span><br><span class="line">│  Update available: 4.0.4  │</span><br><span class="line">└───────────────────────────┘</span><br><span class="line">? Please pick a preset:</span><br><span class="line">  VUE-CLI3 (vue-router, node-sass, babel, eslint)</span><br><span class="line">  default (babel, eslint)</span><br><span class="line">❯ Manually select features</span><br></pre></td></tr></table></figure>

<p>勾选 <code>Babel</code>、<code>Unit Testing</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">? Check the features needed for your project:</span><br><span class="line"> ◉ Babel</span><br><span class="line"> ◯ TypeScript</span><br><span class="line"> ◯ Progressive Web App (PWA) Support</span><br><span class="line"> ◯ Router</span><br><span class="line"> ◯ Vuex</span><br><span class="line"> ◯ CSS Pre-processors</span><br><span class="line"> ◯ Linter &#x2F; Formatter</span><br><span class="line"> ◉ Unit Testing</span><br><span class="line"> ◯ E2E Testing</span><br></pre></td></tr></table></figure>

<p>选择 <code>Jest</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">? Pick a unit testing solution:</span><br><span class="line">  Mocha + Chai</span><br><span class="line">❯ Jest</span><br></pre></td></tr></table></figure>

<p>选择 <code>In dedicated config files</code> 将各配置信息配置在对应的 <code>config</code> 文件里：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">? Where do you prefer placing config for Babel, PostCSS, ESLint, etc.? (Use arrow keys)</span><br><span class="line">❯ In dedicated config files</span><br><span class="line">  In package.json</span><br></pre></td></tr></table></figure>

<p>输入n，不保存预设：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">? Save this as a preset for future projects? (y&#x2F;N) n</span><br></pre></td></tr></table></figure>
<p>项目创建完成后，部分文件的配置信息如下：</p>
<p><code>babel.config.js</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    presets: [</span><br><span class="line">        <span class="string">&#x27;@vue/cli-plugin-babel/preset&#x27;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>jest.config.js</code>， 这个文件的配置默认是预设插件的，可以按实际需求改成上面提到的配置 <code>Jest</code> 里的配置一样。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    preset: <span class="string">&#x27;@vue/cli-plugin-unit-jest&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>package.json</code>:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;first-vue-jest&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;0.1.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;private&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;serve&quot;</span>: <span class="string">&quot;vue-cli-service serve&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;build&quot;</span>: <span class="string">&quot;vue-cli-service build&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;test:unit&quot;</span>: <span class="string">&quot;vue-cli-service test:unit&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;dependencies&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;core-js&quot;</span>: <span class="string">&quot;^3.1.2&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;vue&quot;</span>: <span class="string">&quot;^2.6.10&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;devDependencies&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;@vue/cli-plugin-babel&quot;</span>: <span class="string">&quot;^4.0.0&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;@vue/cli-plugin-unit-jest&quot;</span>: <span class="string">&quot;^4.0.0&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;@vue/cli-service&quot;</span>: <span class="string">&quot;^4.0.0&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;@vue/test-utils&quot;</span>: <span class="string">&quot;1.0.0-beta.29&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;vue-template-compiler&quot;</span>: <span class="string">&quot;^2.6.10&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="执行测试命令"><a href="#执行测试命令" class="headerlink" title="执行测试命令"></a>执行测试命令</h3><p>用上面的步骤创建的项目完成项目后，我们可以在 <code>package.json</code> 的 <code>scripts</code> 项中看到有个 <code>test:unit</code> ，执行它：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd first-vue-jest</span><br><span class="line">npm run test:unit</span><br></pre></td></tr></table></figure>

<p>然后终端里会看到输出结果，<code>PASS</code> 表示测试用例通过了，这个是官方提供单元测试例子。下面我们来写点自己的东西。</p>
<p><img src="https://bubuzou.oss-cn-shenzhen.aliyuncs.com/blog/2019/vue_jest_01.png" alt="first-vue-jest-result"></p>
<h2 id="实现一个ToDoList"><a href="#实现一个ToDoList" class="headerlink" title="实现一个ToDoList"></a>实现一个ToDoList</h2><p><img src="https://bubuzou.oss-cn-shenzhen.aliyuncs.com/blog/2019/vue_jest_02.png" alt="to-do-list"></p>
<p>看上面的原型图，有这么几点明确的需求：</p>
<ul>
<li>在头部右侧输入框输入要做的事情，敲回车后，内容跑到待完成列表里，同时清空输入框</li>
<li>输入框为空的时候敲回车，不做任何变化</li>
<li>待完成列表支持编辑功能，已完成列表不能进行编辑</li>
<li>每个列表项的右侧都有删除按钮，用 <code>-</code> 号表示，点击后删除该项</li>
<li>待完成列表有标记为已完成的按钮，用 <code>√</code> 号表示，点击后当前项移动到已完成列表</li>
<li>已完成列表有标记为未完成的按钮，用 <code>x</code> 号表示，点击后当前项移动到未完成列表</li>
<li>列表序号从1开始递增</li>
<li>当待完成列表为空的时候，不显示待完成字样</li>
<li>当已完成列表为空的时候，不显示已完成字样</li>
</ul>
<h3 id="先把上面的页面写好"><a href="#先把上面的页面写好" class="headerlink" title="先把上面的页面写好"></a>先把上面的页面写好</h3><p>写页面之前先把创建项目的时候生成的 <code>HelloWorld.vue</code> 和对应的测试文件 <code>example.spec.js</code> 删除；同时修改 <code>App.vue</code> 文件，引入 <code>ToDoList</code> 组件：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ToDoList</span>&gt;</span><span class="tag">&lt;/<span class="name">ToDoList</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="keyword">import</span> ToDoList <span class="keyword">from</span> <span class="string">&#x27;./components/ToDoList&#x27;</span></span></span><br><span class="line"></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line">    components: &#123;</span><br><span class="line">        ToDoList</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在 <code>src/compoents</code> 下新建一个文件 <code>ToDoList.vue</code>，样式较多就不贴出来了，具体可以去看<a target="_blank" rel="noopener" href="https://github.com/Bulandent/first-vue-jest.git">本项目源码</a>：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;todolist&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">header</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">h5</span>&gt;</span>ToDoList<span class="tag">&lt;/<span class="name">h5</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">&quot;to-do-text&quot;</span> </span></span><br><span class="line"><span class="tag">                <span class="attr">v-model</span>=<span class="string">&quot;toDoText&quot;</span> </span></span><br><span class="line"><span class="tag">                @<span class="attr">keyup.enter</span>=<span class="string">&quot;enterText&quot;</span> </span></span><br><span class="line"><span class="tag">                <span class="attr">placeholder</span>=<span class="string">&quot;输入计划要做的事情&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h4</span> <span class="attr">v-show</span>=<span class="string">&quot;toDoList.length &gt; 0&quot;</span>&gt;</span>待完成<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;wait-to-do&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">&quot;(item, index) in toDoList&quot;</span> <span class="attr">:keys</span>=<span class="string">&quot;item&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">i</span>&gt;</span>&#123;&#123;index + 1&#125;&#125;<span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">input</span> <span class="attr">:value</span>=<span class="string">&quot;item&quot;</span> @<span class="attr">blur</span>=<span class="string">&quot;setValue(index, $event)&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;move&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;removeToComplete(item, index)&quot;</span>&gt;</span>√<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;del&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;deleteWait(index)&quot;</span>&gt;</span>-<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h4</span> <span class="attr">v-show</span>=<span class="string">&quot;completedList.length &gt; 0&quot;</span>&gt;</span>已完成<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;has-completed&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">&quot;(item, index) in completedList&quot;</span> <span class="attr">:keys</span>=<span class="string">&quot;item&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">i</span>&gt;</span>&#123;&#123;index + 1&#125;&#125;<span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">input</span> <span class="attr">:value</span>=<span class="string">&quot;item&quot;</span> <span class="attr">disabled</span>=<span class="string">&quot;true&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;move&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;removeToWait(item, index)&quot;</span>&gt;</span>x<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;del&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;deleteComplete(index)&quot;</span>&gt;</span>-<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    data() &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            toDoText: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            toDoList: [],</span><br><span class="line">            completedList: []</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    methods: &#123;</span><br><span class="line">        setValue(index, e) &#123;</span><br><span class="line">            <span class="built_in">this</span>.toDoList.splice(index, <span class="number">1</span>, e.target.value)</span><br><span class="line">        &#125;,</span><br><span class="line">        removeToComplete(item, index) &#123;</span><br><span class="line">            <span class="built_in">this</span>.completedList.splice(<span class="built_in">this</span>.completedList.length, <span class="number">0</span>, item)</span><br><span class="line">            <span class="built_in">this</span>.toDoList.splice(index, <span class="number">1</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">        removeToWait(item, index) &#123;</span><br><span class="line">            <span class="built_in">this</span>.toDoList.splice(<span class="built_in">this</span>.toDoList.length, <span class="number">0</span>, item)</span><br><span class="line">            <span class="built_in">this</span>.completedList.splice(index, <span class="number">1</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">        enterText() &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.toDoText.trim().length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.toDoList.splice(<span class="built_in">this</span>.toDoList.length, <span class="number">0</span>, <span class="built_in">this</span>.toDoText)</span><br><span class="line">                <span class="built_in">this</span>.toDoText = <span class="string">&#x27;&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        deleteWait(index) &#123;</span><br><span class="line">            <span class="built_in">this</span>.toDoList.splice(index, <span class="number">1</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">        deleteComplete(index) &#123;</span><br><span class="line">            <span class="built_in">this</span>.completedList.splice(index, <span class="number">1</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>页面写完，原型上的需求也大概开发完成，页面大概长如下样子：</p>
<p><img src="https://bubuzou.oss-cn-shenzhen.aliyuncs.com/blog/2019/vue_jest_03.png"></p>
<h3 id="修改目录配置"><a href="#修改目录配置" class="headerlink" title="修改目录配置"></a>修改目录配置</h3><p>接下来就是开始编写单元测试文件了，写之前我们先把测试文件目录修改下为 <code>__tests__</code>，同时修改 <code>jest.config.js</code> 为如下配置，注意其中的 <code>testMatch</code> 已经修改为匹配 <code>__tests__</code> 目录下的所有 <code>.js</code> 文件了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    moduleFileExtensions: [</span><br><span class="line">        <span class="string">&#x27;js&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;vue&#x27;</span></span><br><span class="line">    ],</span><br><span class="line">    transform: &#123;</span><br><span class="line">        <span class="string">&#x27;^.+\\.vue$&#x27;</span>: <span class="string">&#x27;&lt;rootDir&gt;/node_modules/vue-jest&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;^.+\\.js$&#x27;</span>: <span class="string">&#x27;&lt;rootDir&gt;/node_modules/babel-jest&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    moduleNameMapper: &#123;</span><br><span class="line">        <span class="string">&#x27;^@/(.*)$&#x27;</span>: <span class="string">&#x27;&lt;rootDir&gt;/src/$1&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    snapshotSerializers: [</span><br><span class="line">        <span class="string">&#x27;jest-serializer-vue&#x27;</span></span><br><span class="line">    ],</span><br><span class="line">    testMatch: [<span class="string">&#x27;**/__tests__/**/*.spec.js&#x27;</span>],</span><br><span class="line">    transformIgnorePatterns: [<span class="string">&#x27;&lt;rootDir&gt;/node_modules/&#x27;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="编写测试文件"><a href="#编写测试文件" class="headerlink" title="编写测试文件"></a>编写测试文件</h3><p>在 <code>__tests__/unit/</code> 目录下新建文件 <code>todolist.spec.js</code>，我们约定测试某个 <code>vue</code> 文件，那么它的单元测试文件习惯命名成 <code>*.spec.js</code> 或 <code>*.test.js</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; shallowMount &#125; <span class="keyword">from</span> <span class="string">&#x27;@vue/test-utils&#x27;</span></span><br><span class="line"><span class="keyword">import</span> ToDoList <span class="keyword">from</span> <span class="string">&#x27;@/components/ToDoList&#x27;</span></span><br><span class="line"></span><br><span class="line">describe(<span class="string">&#x27;test ToDoList&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    it(<span class="string">&#x27;输入框初始值为空字符串&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> wrapper = shallowMount(ToDoList)</span><br><span class="line">        expect(wrapper.vm.toDoText).toBe(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>上面这个测试文件简要说明：</p>
<ul>
<li><code>shallowMount</code> 将会创建一个包含被挂载和渲染的 <code>Vue</code> 组件的 <code>Wrapper</code>，只存根当前组件，不包含子组件。</li>
<li><code>describe(name, fn)</code> 这边是定义一个测试套件，<code>test ToDoList</code> 是测试套件的名字，<code>fn</code> 是具体的可执行的函数</li>
<li><code>it(name, fn)</code> 是一个测试用例，<code>输入框初始值为空字符串</code> 是测试用例的名字，<code>fn</code> 是具体的可执行函数；一个测试套件里可以保护多个测试用例。</li>
<li><code>expect</code> 是 <code>Jest</code> 内置的断言风格，业界还存在别的断言风格比如 <code>Should</code>、<code>Assert</code> 等。</li>
<li><code>toBe</code> 是 <code>Jest</code> 提供的断言方法， 更多的可以到<a target="_blank" rel="noopener" href="https://jestjs.io/docs/zh-Hans/expect"><code>Jest Expect</code></a> 查看具体用法。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">&#x27;待完成列表初始值应该为空数组&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> wrapper = shallowMount(ToDoList)</span><br><span class="line">    expect(wrapper.vm.toDoList.length).toBe(<span class="number">0</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">it(<span class="string">&#x27;已完成列表初始值应该为空数组&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> wrapper = shallowMount(ToDoList)</span><br><span class="line">    expect(wrapper.vm.completedList).toEqual([])</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>待完成和已完成列表，居然是列表，所以存放数据的字段必须是 <code>Array</code> 类型，空列表就是空数组。如果第二个测试用例改成：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">expect(wrapper.vm.completedList).toBe([])</span><br></pre></td></tr></table></figure>

<p>将会报错，因为 <code>toBe</code> 方法内部是调用 <code>Object.is(value1, value2)</code> 来比较2个值是否相等的，和 <code>==</code> 或 <code>===</code> 的判断逻辑不一样。显然 <code>Object.is([], [])</code> 会返回 <code>false</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">&#x27;输入框值变化的时候，toDoText应该跟着变化&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> wrapper = shallowMount(ToDoList)</span><br><span class="line">    wrapper.find(<span class="string">&#x27;.to-do-text&#x27;</span>).setValue(<span class="string">&#x27;晚上要陪妈妈逛超市&#x27;</span>)</span><br><span class="line">    expect(wrapper.vm.toDoText).toBe(<span class="string">&#x27;晚上要陪妈妈逛超市&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">it(<span class="string">&#x27;输入框没有值，敲入回车的时候，无变化&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> wrapper = shallowMount(ToDoList)</span><br><span class="line">    <span class="keyword">const</span> length = wrapper.vm.toDoList.length</span><br><span class="line">    <span class="keyword">const</span> input = wrapper.find(<span class="string">&#x27;.to-do-text&#x27;</span>)</span><br><span class="line">    input.setValue(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    input.trigger(<span class="string">&#x27;keyup.enter&#x27;</span>)</span><br><span class="line">    expect(wrapper.vm.toDoList.length).toBe(length)</span><br><span class="line">&#125;)</span><br><span class="line">it(<span class="string">&#x27;输入框有值，敲入回车的时候，待完成列表将新增一条数据，同时清空输入框&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> wrapper = shallowMount(ToDoList)</span><br><span class="line">    <span class="keyword">const</span> length = wrapper.vm.toDoList.length</span><br><span class="line">    <span class="keyword">const</span> input = wrapper.find(<span class="string">&#x27;.to-do-text&#x27;</span>)</span><br><span class="line">    input.setValue(<span class="string">&#x27;晚上去吃大餐&#x27;</span>)</span><br><span class="line">    input.trigger(<span class="string">&#x27;keyup.enter&#x27;</span>)</span><br><span class="line">    expect(wrapper.vm.toDoList.length).toBe(length + <span class="number">1</span>)</span><br><span class="line">    expect(wrapper.vm.toDoText).toBe(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>setValue</code> 可以设置一个文本控件的值并更新 <code>v-model</code> 绑定的数据。</li>
<li><code>.to-do-text</code> 是一个 <code>CSS</code> 选择器；<code>Vue-Test-Utils</code> 提供了 <code>find</code> 方法来通过查找选择器，来返回一个 <code>Wrapper</code>；选择器可以是 <code>CSS</code> 选择器、可以是 <code>Vue</code> 组件也可以是一个对象，这个对象包含了组件的 <code>name</code> 或 <code>ref</code> 属性，比如可以这样用：<code>wrapper.find(&#123; name: &#39;my-button&#39; &#125;)</code></li>
<li><code>wrapper.vm</code> 是一个 <code>Vue</code> 实例，只有 <code>Vue</code> 组件的包裹器才有 <code>vm</code> 这个属性；通过 <code>wrapper.vm</code> 可以访问所有 <a target="_blank" rel="noopener" href="https://vuejs.org/v2/api/#Instance-Properties"><code>Vue</code> 实例的属性和方法</a>。比如：<code>wrapper.vm.$data</code>、<code>wrapper.vm.$nextTick()</code>。</li>
<li><code>trigger</code> 方法可以用来触发一个 <code>DOM</code> 事件，这里触发的事件都是同步的，所以不必将断言放到 <code>$nextTick()</code> 里去执行；同时支持传入一个对象，当捕获到事件的时候，可以获取到传入对象的属性。可以这样写：<code>wrapper.trigger(&#39;click&#39;, &#123;name: &quot;bubuzou.com&quot;&#125;)</code></li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">&#x27;待完成列表支持编辑功能，编辑后更新toDoList数组&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> wrapper = shallowMount(ToDoList)</span><br><span class="line">    wrapper.setData(&#123;<span class="attr">toDoList</span>: [<span class="string">&#x27;跑步半小时&#x27;</span>]&#125;)</span><br><span class="line">    wrapper.find(<span class="string">&#x27;.wait-to-do li&#x27;</span>).find(<span class="string">&#x27;input&#x27;</span>).setValue(<span class="string">&#x27;绕着公园跑3圈&#x27;</span>) </span><br><span class="line">    wrapper.find(<span class="string">&#x27;.wait-to-do li&#x27;</span>).find(<span class="string">&#x27;input&#x27;</span>).trigger(<span class="string">&#x27;blur&#x27;</span>) </span><br><span class="line">    expect(wrapper.vm.toDoList[<span class="number">0</span>]).toBe(<span class="string">&#x27;绕着公园跑3圈&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>先用 <code>setData</code> 给 <code>toDoList</code> 设置一个初始值，使其渲染出一个列表项；然后找到这个列表项，用 <code>setValue</code> 给其设置值，模拟了编辑；列表项的输入框是用 <code>:value=&quot;item&quot;</code> 绑定的 <code>value</code>, 所以 <code>setValue</code> 无法触发更新；只能通过 <code>trigger</code> 来触发更新 <code>toDoList</code> 的值。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">&#x27;待完成列表点击删除，同时更新toDoList数组&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> wrapper = shallowMount(ToDoList)</span><br><span class="line">    wrapper.setData(&#123;<span class="attr">toDoList</span>: [<span class="string">&#x27;睡前看一小时书&#x27;</span>]&#125;)</span><br><span class="line">    expect(wrapper.vm.toDoList.length).toBe(<span class="number">1</span>)</span><br><span class="line">    wrapper.find(<span class="string">&#x27;.wait-to-do li&#x27;</span>).find(<span class="string">&#x27;.del&#x27;</span>).trigger(<span class="string">&#x27;click&#x27;</span>)</span><br><span class="line">    expect(wrapper.vm.toDoList.length).toBe(<span class="number">0</span>)</span><br><span class="line">&#125;)</span><br><span class="line">it(<span class="string">&#x27;点击待完成列表中某项的已完成按钮，数据对应更新&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> wrapper = shallowMount(ToDoList)</span><br><span class="line">    wrapper.setData(&#123;<span class="attr">toDoList</span>: [<span class="string">&#x27;中午饭后吃一个苹果&#x27;</span>]&#125;)</span><br><span class="line">    expect(wrapper.vm.toDoList.length).toBe(<span class="number">1</span>)</span><br><span class="line">    expect(wrapper.vm.completedList.length).toBe(<span class="number">0</span>)</span><br><span class="line">    wrapper.find(<span class="string">&#x27;.wait-to-do li&#x27;</span>).find(<span class="string">&#x27;.move&#x27;</span>).trigger(<span class="string">&#x27;click&#x27;</span>)</span><br><span class="line">    expect(wrapper.vm.toDoList.length).toBe(<span class="number">0</span>)</span><br><span class="line">    expect(wrapper.vm.completedList.length).toBe(<span class="number">1</span>)</span><br><span class="line">&#125;)</span><br><span class="line">it(<span class="string">&#x27;点击已完成列表中某项的未完成按钮，数据对应更新&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> wrapper = shallowMount(ToDoList)</span><br><span class="line">    wrapper.setData(&#123;<span class="attr">completedList</span>: [<span class="string">&#x27;唱了一首歌&#x27;</span>]&#125;)</span><br><span class="line">    expect(wrapper.vm.toDoList.length).toBe(<span class="number">0</span>)</span><br><span class="line">    expect(wrapper.vm.completedList.length).toBe(<span class="number">1</span>)</span><br><span class="line">    wrapper.find(<span class="string">&#x27;.has-completed li&#x27;</span>).find(<span class="string">&#x27;.move&#x27;</span>).trigger(<span class="string">&#x27;click&#x27;</span>)</span><br><span class="line">    expect(wrapper.vm.toDoList.length).toBe(<span class="number">1</span>)</span><br><span class="line">    expect(wrapper.vm.completedList.length).toBe(<span class="number">0</span>)</span><br><span class="line">&#125;)</span><br><span class="line">it(<span class="string">&#x27;列表序号从1开始递增&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> wrapper = shallowMount(ToDoList)</span><br><span class="line">    wrapper.setData(&#123;<span class="attr">toDoList</span>: [<span class="string">&#x27;早上做作业&#x27;</span>, <span class="string">&#x27;下午去逛街&#x27;</span>]&#125;)</span><br><span class="line">    expect(wrapper.vm.toDoList.length).toBe(<span class="number">2</span>)</span><br><span class="line">    expect(wrapper.find(<span class="string">&#x27;.wait-to-do&#x27;</span>).html()).toMatch(<span class="string">&#x27;&lt;i&gt;1&lt;/i&gt;&#x27;</span>)</span><br><span class="line">    expect(wrapper.find(<span class="string">&#x27;.wait-to-do&#x27;</span>).html()).toMatch(<span class="string">&#x27;&lt;i&gt;2&lt;/i&gt;&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">it(<span class="string">&#x27;当待完成列表为空的时候，不显示待完成字样&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> wrapper = shallowMount(ToDoList)</span><br><span class="line">    wrapper.setData(&#123;<span class="attr">toDoList</span>: []&#125;)</span><br><span class="line">    expect(wrapper.find(<span class="string">&#x27;h4&#x27;</span>).isVisible()).toBeFalsy()</span><br><span class="line">    wrapper.setData(&#123;<span class="attr">toDoList</span>: [<span class="string">&#x27;明天去爬北山&#x27;</span>]&#125;)</span><br><span class="line">    expect(wrapper.find(<span class="string">&#x27;h4&#x27;</span>).isVisible()).toBeTruthy()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>一个测试用例中可以写多个 <code>expect</code> 以保证断言的准确性。</p>
<h3 id="异步测试"><a href="#异步测试" class="headerlink" title="异步测试"></a>异步测试</h3><p>最后我们为了模拟异步测试，所以加一个需求，即页面加载的时候会去请求远程待完成列表的数据。<br>在项目根目录新建 <code>__mocks__</code> 目录，同时新建 <code>axios.js</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> toToList = &#123;</span><br><span class="line">    success: <span class="literal">true</span>,</span><br><span class="line">    data: [<span class="string">&#x27;上午去图书馆看书&#x27;</span>, <span class="string">&#x27;下去出去逛街&#x27;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> get = <span class="function">(<span class="params">url</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (url === <span class="string">&#x27;toToList.json&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (toToList.success) &#123;</span><br><span class="line">                resolve(toToList)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                reject(<span class="keyword">new</span> <span class="built_in">Error</span>())</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改 <code>ToDoList.vue</code>，导入 <code>axios</code> 和增加 <code>mounted</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> axios <span class="keyword">from</span> <span class="string">&#x27;../../__mocks__/axios&#x27;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    mounted () &#123;</span><br><span class="line">        axios.get(<span class="string">&#x27;toToList.json&#x27;</span>).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.toDoList = res.data</span><br><span class="line">        &#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">            </span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>测试用例编写为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">&#x27;当页面挂载的时候去请求数据，请求成功后应该会返回2条数据&#x27;</span>, <span class="function">(<span class="params">done</span>) =&gt;</span> &#123;</span><br><span class="line">    wrapper.vm.$nextTick(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        expect(wrapper.vm.toDoList.length).toBe(<span class="number">2</span>)</span><br><span class="line">        done()</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>对于异步的代码，写断言的时候需要放在 <code>wrapper.vm.$nextTick()</code> 里，且手动调用 <code>done()</code>。</p>
<h3 id="配置测试覆盖率"><a href="#配置测试覆盖率" class="headerlink" title="配置测试覆盖率"></a>配置测试覆盖率</h3><p>测试用例写了部分，如果我们看下覆盖率如何，就需要要配置测试覆盖率。在 <code>jest.config.js</code> 里新增配置：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">collectCoverage: <span class="literal">true</span>,</span><br><span class="line">collectCoverageFrom: [<span class="string">&quot;**/*.&#123;js,vue&#125;&quot;</span>, <span class="string">&quot;!**/node_modules/**&quot;</span>],</span><br></pre></td></tr></table></figure>

<p>在 <code>package.json</code> 的 <code>scripts</code> 中新增一条配置:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;test:cov&quot;: &quot;vue-cli-service test:unit --coverage&quot;</span><br></pre></td></tr></table></figure>

<p>然后我们在终端运行： <code>npm run test:cov</code>，结果如下：</p>
<p><img src="https://bubuzou.oss-cn-shenzhen.aliyuncs.com/blog/2019/vue_jest_04.png" alt="test:cov1"></p>
<p>运行测试覆盖率命名后会在项目根目录生成 <code>coverage</code> 目录，浏览器打开里面的 <code>index.html</code> ：</p>
<p><img src="https://bubuzou.oss-cn-shenzhen.aliyuncs.com/blog/2019/vue_jest_05.png" alt="test:cov2"></p>
</div></article></div><div class="right-container"><div class="widget"><div id="arAnchorBar"></div></div></div></section></div><div class="right-menu"></div><div class="modal search-modal"><div class="input-field"><input type="text" id="search_input"><label for="search-input">搜索</label></div><div id="search_result" class="search-result"></div></div><div class="blog-overlay"></div><footer class="row"><div class="footer-con"><div class="paginator"><a href="/2020/03/26/nvm/" title="使用nvm来管理Node版本" class="prev">PREV</a><a href="/2019/09/24/git-all-actions/" title="Git常用操作，一文打尽" class="next">NEXT</a></div><a href="#comment" class="comment-anchor"></a><div id="vcomments"></div><script>new Valine({
    el: "#vcomments",
    appId: "aD8jJBpu4oew3ovNY73z6Rdq-gzGzoHsz",
    appKey: "FdzS5SOPHdhYQoEUngQ8K2QW",
    notify: false,
    verify: false,
    avatar: "robohash",
    visitor: true,
    placeholder: "随便说点什么～.～",
});</script><div class="copyright"><p>© 2016 - 2020 <a href="https://weibo.com/316000381" target="_blank">typeR</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <br> and <a href="https://github.com/Bulandent/hexo-theme-bubuzou" target="_blank">hexo-theme-bubuzou</a></p><p> <span style="padding-right: 6px;">闽ICP备16007301号-2</span></p></div><div class="totop"><i></i></div></div></footer><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src="https://bubuzou.oss-cn-shenzhen.aliyuncs.com/blog/202010/jquery-1.8.2.min.js"></script><script src="https://bubuzou.oss-cn-shenzhen.aliyuncs.com/blog/202010/articleCatalog.js"></script><script src="https://bubuzou.oss-cn-shenzhen.aliyuncs.com/blog/202010/main.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script><script>const valineAPI = (() => {
try {
    AV.init("aD8jJBpu4oew3ovNY73z6Rdq-gzGzoHsz", "FdzS5SOPHdhYQoEUngQ8K2QW");
} catch(error) {}
const isExist = (identity) => {
    identity = identity || getRealPath();
    let query = new AV.Query('Timer');
    return new Promise((resolve, reject) => {
    query.equalTo("identity", identity);
    query.find().then(results => {
        resolve(results.length > 0);
    }, error => reject(error));
    })
}

const _get = (identity) => {
    let query = null;
    if(identity && identity instanceof Array){
    let querys = [];
    for(let i = 0; i < identity.length; ++i) {
        querys[i] = new AV.Query('Timer');
        querys[i].equalTo('identity', identity[i]);
    }
    query = AV.Query.or.apply(null ,querys);
    } else {
    identity = identity || getRealPath();
    query = new AV.Query("Timer");
    query.equalTo("identity", identity);
    }

    return new Promise((resolve, reject) => {
    query.find()
    .then(results => resolve(results))
    .catch(error => reject(error))
    })
}

const create = (identity) => {
    identity = identity || getRealPath();
    return new Promise((resolve, reject) => {
    let Todo = AV.Object.extend('Timer');
    let todo = new Todo();
    todo.set("times", 1);
    todo.set("identity", identity);
    todo.save().then(res => resolve(true), error => reject(error));
    })
}

const update = (identity) => {
    identity = identity || getRealPath();
    return new Promise((resolve, reject) => {
    let query = new AV.Query('Timer');
    query.equalTo("identity", identity);
    query.find().then(todos => {
        todos.forEach(todo => {
        todo.set("times", todo.attributes.times + 1);
        });
        return AV.Object.saveAll(todos);
    }).then(todos => resolve(true), error => reject(error));
    })
}

return {
    isExist,
    _get,
    update,
    create
}
})()

const calcAndWriteTimes = () => {
let isPost = true;

let timerAllDOM = document.querySelectorAll(".article-timer");

if(isPost) {
    let identity = timerAllDOM[0].getAttribute("data-identity");
    valineAPI.isExist(identity)
    .then(exist => {
    if(exist) {
        return valineAPI.update(identity);
    }
    return new Promise(resolve => resolve(true));
    })
    .then( succuess => valineAPI._get(identity))
    .then( result => timerAllDOM[0].innerText = result[0].attributes.times)
    .catch(error => console.log(error.message))
    return ;
}

let timerDOMCache = {};

for(let timerDOM of timerAllDOM) {
    let identity = timerDOM.getAttribute("data-identity");
    if(timerDOMCache.hasOwnProperty(identity)){
    timerDOMCache[identity].dom.push(timerDOM);
    }else{
    timerDOMCache[identity] = {
        dom: [timerDOM],
        times: undefined
    };
    }
}

let identities = Object.keys(timerDOMCache);
valineAPI._get(identities).then(results => {
    for(let result of results) {
    let {identity, times} = result.attributes;
    timerDOMCache[identity].times = times;
    timerDOMCache[identity].dom.map(item => item.innerText = times);
    }
    for(let identity of identities) {
    if(timerDOMCache[identity].times){
        continue;
    }
    timerDOMCache[identity].dom.map(item => item.innerText = 1);
    valineAPI.create(identity);
    }
}).catch(error => console.log(error.message))
}

if(true){
calcAndWriteTimes();
}</script></body></html>